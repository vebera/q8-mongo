services:
  mongodb:
    image: mongo:7.0
    container_name: q8-mongodb
    platform: ${DOCKER_PLATFORM:-linux/amd64}
    restart: unless-stopped
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: admin
      
    # SECURITY: Port exposed for Docker networking
    # MongoDB binds to 0.0.0.0 inside container (required for Docker bridge network)
    # CRITICAL: Configure firewall on host to restrict access to private network only
    # Run: sudo ufw allow from 10.0.0.0/8 to any port 27017 proto tcp
    ports:
      - "${MONGO_PORT:-27017}:27017"
    
    volumes:
      # Data persistence
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      
      # Configuration - temporarily removed to isolate issue
      # - ./mongod.conf:/etc/mongod.conf:ro
      # Keyfile volume removed - only needed for replica sets
      # - ./config/mongodb-keyfile:/etc/mongodb/mongodb-keyfile:ro
      
      # Logs (mounted for log rotation) - temporarily removed
      # - mongodb_logs:/var/log/mongodb
      
      # Backups (mounted for backup scripts)
      - mongodb_backups:/backup
      
    command: 
      # Minimal configuration to isolate startup issue
      - --auth
      - --bind_ip_all
      # Temporarily remove cache size to test if that's the issue
      # - --wiredTigerCacheSizeGB
      # - "${MONGO_CACHE_SIZE_GB:-32}"
      # Log to stderr so errors are visible
      - --logpath
      - /dev/stderr
    
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    deploy:
      resources:
        limits:
          memory: ${MONGO_MEMORY_LIMIT:-50G}
          cpus: '${MONGO_CPU_LIMIT:-6}'
        reservations:
          memory: ${MONGO_MEMORY_RESERVATION:-32G}
          cpus: '${MONGO_CPU_RESERVATION:-2}'
    
    networks:
      - mongodb-network

  # Optional: MongoDB Express for web-based admin (development only)
  # Uncomment for development/testing
  # mongo-express:
  #   image: mongo-express:1.0.2-20
  #   container_name: q8-mongo-express
  #   restart: unless-stopped
  #   ports:
  #     - "${MONGO_EXPRESS_PORT:-8081}:8081"
  #   environment:
  #     ME_CONFIG_MONGODB_SERVER: mongodb
  #     ME_CONFIG_MONGODB_PORT: 27017
  #     ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
  #     ME_CONFIG_MONGODB_AUTH_DATABASE: admin
  #     ME_CONFIG_MONGODB_ADMINUSERNAME: "${MONGO_USER}"
  #     ME_CONFIG_MONGODB_ADMINPASSWORD: "${MONGO_PASSWORD}"
  #     ME_CONFIG_BASICAUTH_USERNAME: "${MONGO_EXPRESS_USER:-admin}"
  #     ME_CONFIG_BASICAUTH_PASSWORD: "${MONGO_EXPRESS_PASSWORD:-admin}"
  #   depends_on:
  #     mongodb:
  #       condition: service_healthy
  #   networks:
  #     - mongodb-network

volumes:
  mongodb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_DATA_DIR:-/var/lib/mongodb}
  
  mongodb_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_CONFIG_DIR:-/var/lib/mongodb-config}
  
  mongodb_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_LOG_DIR:-/var/log/mongodb}
  
  mongodb_backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_BACKUP_DIR:-/var/backups/mongodb}

networks:
  mongodb-network:
    driver: bridge
    name: q8-mongodb-network